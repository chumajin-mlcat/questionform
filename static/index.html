<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åŒ¿åQ&A</title>
  <style>
    :root { --bg:#0b1020; --fg:#e7ecf3; --muted:#9aa6b2; --accent:#4cc9f0; --card:#151b2f; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; background:var(--bg); color:var(--fg); }
    header { padding:16px; border-bottom:1px solid #223; }
    main { max-width:900px; margin:24px auto; padding:0 16px; }
    .card { background:var(--card); border:1px solid #223; border-radius:10px; padding:16px; }
    textarea { width:100%; height:100px; padding:10px; border-radius:8px; border:1px solid #334; background:#0f1528; color:var(--fg); resize:vertical; }
    button { background:var(--accent); color:#03121a; border:none; border-radius:8px; padding:10px 16px; font-weight:600; cursor:pointer; }
    button.secondary { background:#263148; color:var(--fg); }
    .row { display:flex; gap:12px; align-items:center; }
    .space { height:16px; }
    .list { margin-top:16px; display:flex; flex-direction:column; gap:12px; }
    .q { background:#0f1528; border:1px solid #243049; border-radius:10px; padding:12px; display:flex; gap:12px; justify-content:space-between; align-items:flex-start; }
    .q-text { white-space:pre-wrap; word-break:break-word; }
    .q-actions { display:flex; gap:8px; align-items:center; }
    .muted { color:var(--muted); font-size:12px; }
    .admin { margin-top:16px; }
    .pill { background:#1a2238; padding:6px 10px; border-radius:999px; color:var(--muted); font-size:12px; }
    .right { margin-left:auto; }
    @media (max-width: 640px){ .row { flex-direction:column; align-items:stretch; } .right { margin-left:0; } }
  </style>
  <script>
    const API = '/api';
    let order = localStorage.getItem('order') || 'new';
    let adminToken = localStorage.getItem('adminToken') || '';

    function setOrder(v){ order = v; localStorage.setItem('order', v); refresh(); }
    function setAdminToken(v){ adminToken = v; localStorage.setItem('adminToken', v); render(); }

    async function postJSON(url, body, headers={}){
      const res = await fetch(url, { method:'POST', headers: { 'Content-Type':'application/json', ...headers }, body: JSON.stringify(body) });
      if(!res.ok){ const e = await res.json().catch(()=>({detail: res.statusText})); throw new Error(e.detail || 'ã‚¨ãƒ©ãƒ¼'); }
      return res.json();
    }
    async function postNoBody(url, headers={}){
      const res = await fetch(url, { method:'POST', headers });
      if(!res.ok){ const e = await res.json().catch(()=>({detail: res.statusText})); throw new Error(e.detail || 'ã‚¨ãƒ©ãƒ¼'); }
      return res.json();
    }
    async function del(url, headers={}){
      const res = await fetch(url, { method:'DELETE', headers });
      if(!res.ok){ const e = await res.json().catch(()=>({detail: res.statusText})); throw new Error(e.detail || 'ã‚¨ãƒ©ãƒ¼'); }
      return res.json();
    }

    async function submitQuestion(){
      const ta = document.getElementById('qtext');
      const text = ta.value.trim();
      if(!text){ alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      try {
        await postJSON(`${API}/questions`, { text });
        ta.value='';
        refresh();
      } catch(e){ alert(e.message); }
    }

    async function vote(id){
      try{ await postNoBody(`${API}/questions/${id}/vote`); refresh(); } catch(e){ alert(e.message); }
    }
    async function hideQ(id){
      if(!adminToken){ alert('ç®¡ç†ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      try{ await postNoBody(`${API}/questions/${id}/hide`, { 'X-Admin-Token': adminToken }); refresh(); } catch(e){ alert(e.message); }
    }
    async function unhideQ(id){
      if(!adminToken){ alert('ç®¡ç†ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      try{ await postNoBody(`${API}/questions/${id}/unhide`, { 'X-Admin-Token': adminToken }); refresh(); } catch(e){ alert(e.message); }
    }
    async function delQ(id){
      if(!adminToken){ alert('ç®¡ç†ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if(!confirm('ã“ã®è³ªå•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try{ await del(`${API}/questions/${id}`, { 'X-Admin-Token': adminToken }); refresh(); } catch(e){ alert(e.message); }
    }

    async function refresh(){
      const includeHidden = !!adminToken;
      const res = await fetch(`${API}/questions?order=${order}&include_hidden=${includeHidden}`);
      const data = await res.json();
      renderList(data);
    }

    function fmt(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return ts; } }

    function renderList(items){
      const list = document.getElementById('list');
      list.innerHTML = '';
      if(items.length === 0){ list.innerHTML = '<div class="muted">ã¾ã è³ªå•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }
      for(const q of items){
        const el = document.createElement('div');
        el.className = 'q';
        const left = document.createElement('div');
        left.style.flex = '1';
        left.innerHTML = `<div class="q-text">${escapeHtml(q.text)}</div>` +
          `<div class="muted">#${q.id} / ç¥¨: ${q.votes} / ${fmt(q.created_at)}${q.hidden ? ' / éè¡¨ç¤º' : ''}</div>`;
        const actions = document.createElement('div');
        actions.className = 'q-actions';
        const btnUp = document.createElement('button'); btnUp.textContent = `ğŸ‘ ç¥¨ã‚’å…¥ã‚Œã‚‹ (${q.votes})`; btnUp.onclick=()=>vote(q.id);
        actions.appendChild(btnUp);
        if(adminToken){
          const btnHide = document.createElement('button'); btnHide.className='secondary'; btnHide.textContent = q.hidden ? 'è¡¨ç¤ºã«æˆ»ã™' : 'éè¡¨ç¤º'; btnHide.onclick=()=> (q.hidden ? unhideQ(q.id) : hideQ(q.id));
          const btnDel = document.createElement('button'); btnDel.className='secondary'; btnDel.textContent = 'å‰Šé™¤'; btnDel.onclick=()=>delQ(q.id);
          actions.appendChild(btnHide); actions.appendChild(btnDel);
        }
        el.appendChild(left); el.appendChild(actions);
        list.appendChild(el);
      }
    }

    function render(){
      document.getElementById('order-new').className = order==='new' ? 'pill' : 'muted pill';
      document.getElementById('order-top').className = order==='top' ? 'pill' : 'muted pill';
      document.getElementById('adminToken').value = adminToken;
    }

    function escapeHtml(str){
      return str.replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    setInterval(refresh, 5000);
    window.addEventListener('load', ()=>{ render(); refresh(); });
  </script>
</head>
<body>
  <header>
    <div style="max-width:900px;margin:0 auto;padding:0 16px;display:flex;align-items:center;gap:12px;">
      <div style="font-weight:800;">åŒ¿åQ&A</div>
      <a href="/projector" class="right" style="color:var(--accent);text-decoration:none;">æŠ•å½±ç”¨ç”»é¢ â†’</a>
    </div>
  </header>
  <main>
    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">è³ªå•ã‚’æŠ•ç¨¿</div>
      <textarea id="qtext" maxlength="500" placeholder="è³ªå•ã‚’å…¥åŠ›ï¼ˆ500æ–‡å­—ã¾ã§ï¼‰"></textarea>
      <div class="row" style="margin-top:8px;">
        <div class="muted">ã‚¹ãƒ‘ãƒ é˜²æ­¢ã®ãŸã‚ç®¡ç†å´ã§éè¡¨ç¤ºãƒ»å‰Šé™¤ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</div>
        <div class="right">
          <button onclick="submitQuestion()">è³ªå•ã‚’é€ä¿¡</button>
        </div>
      </div>
    </div>

    <div class="space"></div>

    <div class="row">
      <div id="order-new" class="pill" onclick="setOrder('new')">æ–°ç€é †</div>
      <div id="order-top" class="muted pill" onclick="setOrder('top')">æŠ•ç¥¨é †</div>
      <div class="right admin">
        <input id="adminToken" type="password" placeholder="ç®¡ç†ãƒˆãƒ¼ã‚¯ãƒ³" style="background:#0f1528;border:1px solid #334;border-radius:8px;padding:8px;color:var(--fg);" oninput="setAdminToken(this.value)" />
      </div>
    </div>

    <div class="list" id="list"></div>
  </main>
</body>
</html>

